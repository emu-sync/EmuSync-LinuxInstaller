name: Build & Release

on:
  push:
    tags:
      - 'v*'  # triggers only on tags like v1.2.3

env:
  LINUX_INSTALLER_DIR: src

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
  
      - name: Debug Git ref
        run: echo "GITHUB_REF=$GITHUB_REF"
  
      - name: Get release version from tag
        id: get-version
        run: |
          # Remove 'refs/tags/' prefix
          VERSION="${GITHUB_REF#refs/tags/}"
          # Optionally strip leading 'v' if your tags are like 'v1.2.3'
          VERSION="${VERSION#v}"
  
          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is empty! Make sure this workflow is triggered by a tag."
            exit 1
          fi
  
          echo "Release version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload Linux installer files
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer-files
          path: |
            ${{ env.LINUX_INSTALLER_DIR }}/EmuSync-LinuxInstaller.desktop
            ${{ env.LINUX_INSTALLER_DIR }}/user-install-script.sh

  release:
    needs: prep
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux installer files
        uses: actions/download-artifact@v4
        with:
          name: linux-installer-files
          path: artifacts/linux-installer-files

      - name: Upload Linux installer files to release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/linux-installer-files/* 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}